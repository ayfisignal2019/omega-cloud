<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f0">
  <title>Omega V∞ CLOUD</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {font-family: Tahoma; background:#000; color:#0f0; padding:20px; text-align:center;}
    .card {background:#111; border:2px solid #0f0; padding:20px; margin:20px auto; max-width:500px; border-radius:15px;}
    input, button {width:100%; margin:10px 0; padding:12px; border-radius:8px; font-size:1em;}
    input {background:#000; color:#0f0; border:1px solid #0f0;}
    button {background:#0f0; color:#000; border:none; font-weight:bold; cursor:pointer;}
    #log {max-height:60vh; overflow-y:auto; background:#000; border:1px solid #0f0; padding:15px; margin:20px auto; border-radius:10px; font-size:0.9em;}
    .buy {color:#0f0; font-weight:bold;} .sell {color:#f55; font-weight:bold;}
    .status {color:#0a0; font-weight:bold; margin:10px 0;}
    .update {color:#0af; font-size:0.8em; margin:5px 0;}
  </style>
</head>
<body>
  <h1>Omega V∞ CLOUD</h1>
  <div class="status" id="status">در حال بارگذاری...</div>
  <div class="update" id="update">آپدیت خودکار فعال</div>

  <div class="card">
    <input id="tg_token" placeholder="توکن تلگرام (مثلاً 123456:ABC...)" />
    <input id="tg_chat" placeholder="آیدی چت (مثلاً -1001234567890)" />
    <input id="gmail_user" placeholder="ایمیل جیمیل (example@gmail.com)" />
    <input id="gmail_pass" type="password" placeholder="پسورد اپلیکیشن" />
    <button onclick="save()">ذخیره و فعال‌سازی</button>
  </div>

  <div id="log" class="card"></div>

  <script>
    const EXCHANGES = ['kucoin','gateio','mexc','coinex','bitget','okx','bybit'];
    const REPO_USER = "YOUR_GITHUB_USERNAME"; // <<<--- اینجا اسم کاربری گیت‌هاب خودت رو بذار
    const REPO_NAME = "omega-cloud";         // <<<--- اسم مخزن رو عوض نکن
    const UPDATE_URL = `https://api.github.com/repos/${REPO_USER}/${REPO_NAME}/commits/main`;

    const log = (msg, type='') => {
      const d = document.createElement('div');
      d.innerHTML = `<small style="color:#888">${new Date().toLocaleTimeString('fa-IR')}</small> <span class="${type}">${msg}</span>`;
      const logEl = document.getElementById('log');
      logEl.prepend(d);
      if (logEl.children.length > 100) logEl.removeChild(logEl.lastChild);
    };

    function save() {
      ['tg_token','tg_chat','gmail_user','gmail_pass'].forEach(id => 
        localStorage.setItem(id, document.getElementById(id).value.trim())
      );
      document.getElementById('status').textContent = 'ذخیره شد — ربات فعال';
      log('اطلاعات ذخیره شد — ربات شروع شد', 'buy');
      startBot();
    }

    async function sendTG(msg) {
      const t = localStorage.getItem('tg_token'), c = localStorage.getItem('tg_chat');
      if (t && c) {
        try { await fetch(`https://api.telegram.org/bot${t}/sendMessage?chat_id=${c}&text=${encodeURIComponent(msg)}&parse_mode=HTML`); }
        catch(e) { log('خطا در ارسال تلگرام', 'sell'); }
      }
    }

    async function sendGmail(sub, body) {
      const u = localStorage.getItem('gmail_user'), p = localStorage.getItem('gmail_pass');
      if (u && p && window.Email) {
        try { await Email.send({Host:"smtp.gmail.com",Username:u,Password:p,To:u,From:u,Subject:sub,Body:body}); }
        catch(e) { log('خطا در ارسال جیمیل', 'sell'); }
      }
    }

    async function analyze(sym) {
      for (let ex of EXCHANGES) {
        try {
          const url = {
            kucoin: `https://api.kucoin.com/api/v1/market/candles?type=1hour&symbol=${sym.replace('/', '-')}`,
            gateio: `https://api.gate.io/api4/v4/spot/candlesticks?currency_pair=${sym.replace('/', '_')}&interval=1h`,
            mexc: `https://api.mexc.com/api/v3/klines?symbol=${sym.replace('/', '')}&interval=1h&limit=50`,
            coinex: `https://api.coinex.com/v1/market/kline?market=${sym.replace('/', '')}&type=1h&limit=50`,
            bitget: `https://api.bitget.com/api/spot/v1/market/candles?symbol=${sym.replace('/', '')}&period=1h&limit=50`,
            okx: `https://www.okx.com/api/v5/market/candles?instId=${sym.replace('/', '-')}&bar=1H`,
            bybit: `https://api.bybit.com/v5/market/kline?category=spot&symbol=${sym.replace('/', '')}&interval=60&limit=50`
          }[ex];
          const res = await fetch(url, {signal: AbortSignal.timeout(4000)});
          if (!res.ok) continue;
          const data = await res.json();
          const klines = (data.data || data).slice(-50);
          if (klines.length < 20) continue;
          const closes = klines.map(k => parseFloat(k[4]));
          const price = closes[closes.length-1];
          const rsi = closes.length > 14 ? (function(c){
            let up=0, down=0;
            for(let i=c.length-14; i<c.length; i++){
              const d = c[i] - c[i-1];
              if(d>0) up+=d; else down-=d;
            }
            return 100 - (100 / (1 + (up/14)/(down/14||1)));
          })(closes) : 50;
          const sma20 = closes.slice(-20).reduce((a,b)=>a+b,0)/20;
          const pred = 0.5 + (rsi/100 * 0.35 + (price/sma20) * 0.3 + Math.random()*0.1) * 0.9;
          if (pred > 0.72) {
            const dir = pred > 0.78 ? 'BUY' : 'SELL';
            const atr = price * 0.0055;
            const msg = `<b>سیگنال ${dir}</b>\n<code>${sym}</code>\nورود: <b>${price.toFixed(6)}</b>\nSL: <b>${(dir==='BUY'?price-atr:price+atr).toFixed(6)}</b>\nTP1: <b>${(dir==='BUY'?price+atr*1.6:price-atr*1.6).toFixed(6)}</b>\nTP2: <b>${(dir==='BUY'?price+atr*3.2:price-atr*3.2).toFixed(6)}</b>\nاعتماد: <b>${(pred*100).toFixed(1)}%</b>`;
            log(msg.replace(/\n/g,'<br>'), dir.toLowerCase());
            await sendTG(msg);
            await sendGmail(`سیگنال ${dir} ${sym}`, msg);
            return true;
          }
        } catch(e) {}
      }
      return false;
    }

    async function rotate() {
      const scores = {};
      for (let ex of EXCHANGES) {
        try {
          const url = {
            kucoin: "https://api.kucoin.com/api/v1/market/allTickers",
            gateio: "https://api.gate.io/api4/v4/spot/tickers",
            mexc: "https://api.mexc.com/api/v3/ticker/24hr",
            coinex: "https://api.coinex.com/v1/market/ticker/all",
            bitget: "https://api.bitget.com/api/spot/v1/market/tickers",
            okx: "https://www.okx.com/api/v5/market/tickers?instType=SPOT",
            bybit: "https://api.bybit.com/v5/market/tickers?category=spot"
          }[ex];
          const res = await fetch(url, {signal: AbortSignal.timeout(5000)});
          if (!res.ok) continue;
          const data = await res.json();
          const items = data.data || data.ticker || data;
          for (let i of (Array.isArray(items)?items:Object.values(items))) {
            let sym = (i.symbol || i.instId || i.s || '').replace('-','/').replace('_','/');
            if (sym.includes('/USDT')) {
              const vol = parseFloat(i.quoteVolume || i.vol || i.q || 0);
              const price = parseFloat(i.lastPrice || i.last || i.c || 0);
              const change = Math.abs(parseFloat(i.priceChangePercent || i.P || 0));
              if (vol * price > 250000) scores[sym] = vol * price * (1 + change/100);
            }
          }
        } catch(e) {}
      }
      return Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,50);
    }

    async function run() {
      document.getElementById('status').textContent = 'در حال اسکن ۷ صرافی...';
      log('شروع اسکن...');
      const syms = await rotate();
      document.getElementById('status').textContent = `تحلیل ${syms.length} توکن برتر`;
      let count = 0;
      for (let sym of syms) {
        if (await analyze(sym)) count++;
      }
      document.getElementById('status').textContent = count ? `${count} سیگنال ارسال شد` : 'بدون سیگنال قوی';
    }

    function startBot() {
      setInterval(run, 150000); // هر ۲.۵ دقیقه
      run();
      log('ربات ۲۴ ساعته فعال شد', 'buy');
    }

    // --- آپدیت خودکار روزانه ---
    setInterval(async () => {
      try {
        const res = await fetch(UPDATE_URL);
        const data = await res.json();
        const last = localStorage.getItem('last_commit');
        if (last && data.sha !== last) {
          log('آپدیت جدید پیدا شد — رفرش خودکار...', 'buy');
          localStorage.setItem('last_commit', data.sha);
          setTimeout(() => location.reload(), 5000);
        } else if (!last) {
          localStorage.setItem('last_commit', data.sha);
        }
      } catch(e) { log('خطا در چک آپدیت', 'sell'); }
    }, 86400000); // هر ۲۴ ساعت

    // --- SMTP.js ---
    const s = document.createElement('script');
    s.src = 'https://smtpjs.com/v3/smtp.js';
    document.head.appendChild(s);

    // --- شروع خودکار ---
    window.onload = () => {
      document.getElementById('status').textContent = 'آماده';
      if (localStorage.getItem('tg_token') && localStorage.getItem('gmail_user')) {
        document.getElementById('status').textContent = 'اطلاعات موجود — ربات فعال';
        startBot();
      }
    };
  </script>
</body>
</html>
